---
status: complete
priority: p1
issue_id: "002"
tags: [code-review, security, critical]
dependencies: []
---

# Path Traversal Vulnerability in File Operations

## Problem Statement

The scripts accept user-provided file paths for output without validating that paths don't escape intended directories using `..` sequences. An attacker can write files anywhere on the filesystem.

This is a CRITICAL security vulnerability that blocks the PR merge.

## Findings

### Affected Files
- `scripts/create-job.py:571,615` - Output path from args/config used directly
- `scripts/create-job.py:605-607` - Config name used to construct filename
- `scripts/validate-job.py:148,200` - Resolved paths not validated

### Evidence
```bash
# Attacker can write to arbitrary locations
python create-job.py --config safe.json --output "../../../etc/cron.d/malicious"

# Or via interactive mode job name:
# Job name: ../../../tmp/evil
```

### CVSS Score
8.8 (High) - CWE-22

## Proposed Solutions

### Option A: Path containment validation (Recommended)
- **Pros**: Direct fix, comprehensive
- **Cons**: Must be applied at all entry points
- **Effort**: Small (3 hours)
- **Risk**: Low

```python
from pathlib import Path

def validate_safe_path(base_dir: Path, user_path: str) -> Path:
    """Validate path doesn't escape base directory."""
    full_path = (base_dir / user_path).resolve()
    try:
        full_path.relative_to(base_dir.resolve())
    except ValueError:
        raise ValueError(f"Path traversal attempt detected: {user_path}")
    return full_path
```

### Option B: Sanitize filenames only
- **Pros**: Simpler implementation
- **Cons**: Only fixes filename issues, not full paths
- **Effort**: Small (1 hour)
- **Risk**: Medium - may miss edge cases

```python
import re
def sanitize_filename(name: str) -> str:
    name = re.sub(r'[^\w\-.]', '_', name)
    name = name.lstrip('.-')
    return name or "job"
```

## Recommended Action

**Implement Option A** for all file operations, plus **Option B** for filename generation from user input.

## Technical Details

### Affected Files
1. `plugins/epublisher-automation/skills/automap/scripts/create-job.py`
2. `plugins/epublisher-automation/skills/automap/scripts/validate-job.py`

### Vulnerable Functions
- `main()` in create-job.py where output_path is constructed
- Interactive mode where job name is used as filename

## Acceptance Criteria

- [ ] `validate_safe_path()` function created and used for all file outputs
- [ ] `sanitize_filename()` function created and used for all user-provided names
- [ ] Test cases added for path traversal attempts (`../`, absolute paths)
- [ ] Error messages shown when path traversal detected

## Work Log

| Date | Action | Result |
|------|--------|--------|
| 2025-12-05 | Identified during code review | 2 scripts affected |
| 2025-12-05 | Approved during triage | Status: pending → ready |
| 2025-12-05 | Resolved: sanitize_filename() and validate_safe_path() added | Status: ready → complete |

## Resources

- PR: https://github.com/quadralay/webworks-claude-skills/pull/1
- OWASP Path Traversal: https://owasp.org/www-community/attacks/Path_Traversal
