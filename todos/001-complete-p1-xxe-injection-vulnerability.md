---
status: complete
priority: p1
issue_id: "001"
tags: [code-review, security, critical]
dependencies: []
---

# XXE Injection Vulnerability in XML Parsing

## Problem Statement

All 5 Python scripts use `xml.etree.ElementTree.parse()` without disabling external entity processing. This allows attackers to:
- Read arbitrary files from the system (File Disclosure)
- Perform Server-Side Request Forgery (SSRF) attacks
- Cause Denial of Service (Billion Laughs attack)

This is a CRITICAL security vulnerability that blocks the PR merge.

## Findings

### Affected Files
- `scripts/create-job.py:96` - `ET.parse(stationery_path)`
- `scripts/validate-job.py:107,255` - `ET.parse(job_file)`, `ET.parse(str(stationery_path))`
- `scripts/parse-stationery.py:76` - `ET.parse(stationery_file)`
- `scripts/parse-job.py:76` - `ET.parse(job_file)`
- `scripts/list-job-targets.py:67` - `ET.parse(job_file)`

### Evidence
A malicious .waj or .wxsp file could contain:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<Job name="&xxe;" version="1.0">
```

### CVSS Score
9.1 (Critical) - CWE-611

## Proposed Solutions

### Option A: Use defusedxml library (Recommended)
- **Pros**: Drop-in replacement, comprehensive protection
- **Cons**: Adds external dependency
- **Effort**: Small (2 hours)
- **Risk**: Low

```python
# Add to requirements
# defusedxml>=0.7.1

import defusedxml.ElementTree as ET
```

### Option B: Manually disable entities
- **Pros**: No external dependency
- **Cons**: More code, easier to miss edge cases
- **Effort**: Medium (4 hours)
- **Risk**: Medium

```python
from xml.etree.ElementTree import XMLParser

def parse_xml_safely(file_path):
    parser = XMLParser()
    parser.entity = {}  # Disable entity expansion
    tree = ET.parse(file_path, parser=parser)
    return tree
```

## Recommended Action

**Implement Option A** - Use `defusedxml` library in all 5 scripts.

## Technical Details

### Affected Files
1. `plugins/epublisher-automation/skills/automap/scripts/create-job.py`
2. `plugins/epublisher-automation/skills/automap/scripts/validate-job.py`
3. `plugins/epublisher-automation/skills/automap/scripts/parse-stationery.py`
4. `plugins/epublisher-automation/skills/automap/scripts/parse-job.py`
5. `plugins/epublisher-automation/skills/automap/scripts/list-job-targets.py`

### Affected Components
- All XML parsing functions

## Acceptance Criteria

- [ ] All ET.parse() calls replaced with defusedxml equivalent
- [ ] defusedxml added to requirements.txt or documented as dependency
- [ ] Scripts tested with XXE payload files to verify protection
- [ ] Scripts tested with Billion Laughs payload to verify DoS protection

## Work Log

| Date | Action | Result |
|------|--------|--------|
| 2025-12-05 | Identified during code review | All 5 scripts affected |
| 2025-12-05 | Approved during triage | Status: pending → ready |
| 2025-12-05 | Resolved: defusedxml in all 5 scripts | Status: ready → complete |

## Resources

- PR: https://github.com/quadralay/webworks-claude-skills/pull/1
- OWASP XXE: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
- defusedxml: https://pypi.org/project/defusedxml/
